@page "/foodlogging"
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject WebsiteFirstDraft.Data.Models.AppDbContext Db
@using WebsiteFirstDraft.Data
@using WebsiteFirstDraft.Data.Models
@using BlazorBootstrap.Components

<link rel="stylesheet " href="~/customcsspages/FoodLogging.css"/>

<h3 class="text-center">Food Logging</h3>
<p class="blockquote text-center">Welcome to the Food Logging Page</p>
<p class="blockquote text-center">Here you can search for food items from our database and add/remove entries</p>

<div class="container-fluid">
    <div class="row d-flex align-items-stretch">

        <!-- Textarea column -->
        <div class="col-sm-10 d-flex">
            <textarea class="form-control w-100" style="resize:none; min-height:70px;"
                      placeholder="Search for Food Item from Database"></textarea>
        </div>

        <!-- Button column -->
        <div class="col-sm-2 d-flex">
            <p class="w-100 h-100" style="padding: 2px; margin: 2px; border-radius: 5px;">
                <a href="https://calculator.academy/servings-calculator/">How we calculate serving sizes</a>
            </p>
        </div>

    </div>
</div>
<hr />
@*Food item table loaded from the SQL server database with CRUD options*@
<div class="container-fluid">
    <div class="row d-flex align-items-stretch">

        <table>
            <thead>
                <tr>
                    <th>Food Types</th>
                    <th>Food Names</th>
                    <th>Calories Per Gram</th>
                    <th>Carbs Per Gram</th>
                    <th>Protein Per Gram</th>
                    <th>Fat Per Gram</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var foodType in Food_items)
                {
                    <tr>
                        <td>
                            <input @bind="foodType.Food_Type"/>
                        </td>
                        <td>
                            <input @bind="foodType.Food_Name" />
                        </td>
                        <td>
                            <input @bind="foodType.Calories_Per_Gram" />
                        </td>
                        <td>
                            <input @bind="foodType.Carbs_Per_Gram" />
                        </td>
                        <td>
                            <input @bind="foodType.Protein_Per_Gram" />
                        </td>
                        <td>
                            <input @bind="foodType.Fat_Per_Gram" />
                        </td>
                        <td>
                            <Button Color="ButtonColor.Success" @onclick="() => Update(foodType)">Save</Button>
                            <Button Color="ButtonColor.Danger" @onclick="() => Delete(foodType.Food_Id)">Delete</Button>
                            <Button Color="ButtonColor.Primary" @onclick="() => OpenPopup(foodType)">Log Food Item</Button>
                        </td>
                    </tr>
                }
                <tr>
                    <td>
                        <input />
                    </td>
                    <td>
                        <input  />
                    </td>
                    <td>
                        <input  />
                    </td>
                    <td>
                        <input  />
                    </td>
                    <td>
                        <button type="button" @onclick="() => Create()">Add</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <Popup @bind-IsVisible="showPopup" Title="Food Logging Page">
            <p>Name of Food</p>
            <div class="container">

                @*Duration*@
                <div class="row align-items-center mb-3">
                    <div class="col-4 text-end">
                        <label class="form-label mb-0">Serving Size (grams)</label>
                    </div>
                    <div class="col-8">
                        <div class="input-group" style="max-width: 160px;">
                            @*Minus button*@
                            <button class="btn btn-outline-secondary" @onclick="DecrementDuration" disabled="@(grams <= 0)">−</button>

                            @*Numeric bound input*@
                            <input type="number" class="form-control text-center" @bind="grams" />

                            @*Plus button*@
                            <button class="btn btn-outline-secondary" @onclick="IncrementDuration">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-sm-flex justify-content-between">
                <button type="button" class="btn btn-primary" @onclick="() => DisplayLog(grams)">Log</button>
                <button type="button" class="btn btn-primary">Graphs</button>
            </div>

            @if (display)
            {
                <br />
                <p>Do you wish to log @calories calories?</p>
                <Button Color="ButtonColor.Primary">Confirm</Button>
            }
        </Popup>

    </div>
</div>

@code {

    private void NavToDietQuestionnaire()
    {
        NavigationManager.NavigateTo("dietquestionnaire");
    }

    // Holds all FoodType records currently displayed in the UI
    // This list is typically bound to a table or list in the Razor markup
    private List<FoodType> Food_items = new List<FoodType>();

    // Temporary object used for creating a new FoodType entry
    // This is usually bound to a form input
    private FoodType newFoodType = new();

    protected override void OnInitialized()
    {
        // Called once when the component is first initialised
        // Loads all FoodTypes from the database into memory
        // so they can be displayed in the UI
        Food_items = Db.Food_items.ToList();
    }

    void Create()
    {
        // Set database column Id as identity so it will automatically increment. Any exceptions are caught so that the application doesnt crash

        try
        {
            // Adds the new food type to the database context
            Db.Food_items.Add(newFoodType);

            // Persists the change to the database.
            Db.SaveChanges();

            // Adds the newly created food type to the local list so the UI updates immediately
            Food_items.Add(newFoodType);

            // Optionally log the newly generated Id
            System.Console.WriteLine($"Created FoodType with Id {newFoodType.Food_Id}");

            // Resets the form by creating a new empty object
            newFoodType = new();
        }
        catch (Exception ex)
        {
            // Minimal error handling - log for debugging
            System.Console.WriteLine($"Error creating FoodType: {ex.Message}");
        }
    }

    void Update(FoodType food_types)
    {
        // Marks the provided food type as modified in the database context
        Db.Food_items.Update(food_types);

        // Saves the updated values to the database
        Db.SaveChanges();
    }

    void Delete(int id)
    {
        // Logs the deletion attempt (useful for debugging)
        System.Console.WriteLine($"Deleting {id}");

        // Finds the food type by primary key
        var foodType = Db.Food_items.Find(id);

        // If the record does not exist, exit safely
        if (foodType is null) return;

        // Removes the entity from the database
        Db.Food_items.Remove(foodType);
        Db.SaveChanges();

        // Removes the entity from the local list so the UI updates immediately
        Food_items.Remove(foodType);
    }

    // Search functionality
    // Stores the user's search input
    private string searchText = "";

    // Holds the filtered search results
    // This is usually bound to a results list or table
    private List<FoodType> myresults = new();

    void Search()
    {
        // Queries the database for food types where
        // the food names field contains the search text
        // and stores the results in myresults
        myresults = Db.Food_items
            .Where(e => e.Food_Name.Contains(searchText))
            .ToList();
    }


    // Popup related code
    private bool showPopup;
    double caloriesPerGram = 0;
    double calories = 0;


    //Opens the pop up and captures the value of the current exercise calories burnt per minute attribute inside a string.
    private void OpenPopup(FoodType e)
    {
        caloriesPerGram = e.Calories_Per_Gram;
        showPopup = true;

    }


    private double grams = 0;

    //Increments and decrements the duration value by 1 minute.
    private void IncrementDuration() => grams++;
    private void DecrementDuration() => grams--;

    private bool display;

    //Displays the total number of calories burnt as an integer
    private async Task DisplayLog(double grams)
    {
        calories = caloriesPerGram * grams;
        display = true;
        calories = (int)calories;

    }
}
