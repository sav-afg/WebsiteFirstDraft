@page "/maintenancecaloriesquestionnaire"
@using WebsiteFirstDraft.Data.Models
@inject NavigationManager Navigation
@rendermode InteractiveServer
@inject MaintenanceCalorieCalculator Calc
@inject UserSessionService Session
@inject AppDbContext Db

@using Microsoft.AspNetCore.Components.Forms

<div class="container mt-5 mb-5 pb-5">

    @* PAGE TITLE *@
    <div class="text-center mb-4">
        <h2 class="fw-bold">Daily Calorie Maintenance Calculator</h2>
        <p class="text-muted">
            Answer the questions below to calculate your daily calorie maintenance needs based on your body metrics and activity level.
        </p>
    </div>

    @* QUESTIONNAIRE CARD *@
    <div class="card shadow-sm">
        <div class="card-body">

            @* QUESTION 1: SEX *@
            <div class="mb-4">
                <label class="form-label">
                    <strong>1. What is your sex?</strong>
                </label>
                <select class="form-select" @bind="Calc.Sex">
                    <option disabled value="">Select an option</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>

            @* QUESTION 2: HEIGHT *@
            <div class="mb-4">
                <label class="form-label">
                    <strong>2. What is your height? (in centimeters)</strong>
                </label>
                <div class="input-group">
                    <input type="number" 
                           class="form-control" 
                           @bind="Calc.HeightCm" 
                           @bind:event="oninput"
                           placeholder="e.g., 175"
                           min="100"
                           max="250"
                           step="0.1" />
                    <span class="input-group-text">cm</span>
                </div>
                <small class="form-text text-muted">Enter your height in centimeters (e.g., 175 cm)</small>
            </div>

            @* QUESTION 3: WEIGHT *@
            <div class="mb-4">
                <label class="form-label">
                    <strong>3. What is your weight? (in kilograms)</strong>
                </label>
                <div class="input-group">
                    <input type="number" 
                           class="form-control" 
                           @bind="Calc.WeightKg" 
                           @bind:event="oninput"
                           placeholder="e.g., 70"
                           min="30"
                           max="300"
                           step="0.1" />
                    <span class="input-group-text">kg</span>
                </div>
                <small class="form-text text-muted">Enter your weight in kilograms (e.g., 70 kg)</small>
            </div>

            @* QUESTION 4: AGE *@
            <div class="mb-4">
                <label class="form-label">
                    <strong>4. What is your age?</strong>
                </label>
                <input type="number" 
                       class="form-control" 
                       @bind="Calc.Age" 
                       @bind:event="oninput"
                       placeholder="e.g., 25"
                       min="15"
                       max="100" />
                <small class="form-text text-muted">Enter your age in years</small>
            </div>

            @* QUESTION 5: PHYSICAL ACTIVITY LEVEL *@
            <div class="mb-4">
                <label class="form-label">
                    <strong>5. What is your physical activity level?</strong>
                </label>
                <InputRadioGroup @bind-Value="Calc.ActivityLevel">
                    <div class="form-check">
                        <InputRadio class="form-check-input" 
                                    id="NoExercise" 
                                    Value="PhysicalActivityLevel.NoExercise" />
                        <label class="form-check-label" for="NoExercise">
                            I do not exercise
                        </label>
                    </div>
                    <div class="form-check">
                        <InputRadio class="form-check-input" 
                                    id="RegularExercise" 
                                    Value="PhysicalActivityLevel.RegularExercise" />
                        <label class="form-check-label" for="RegularExercise">
                            I exercise regularly
                        </label>
                    </div>
                    <div class="form-check">
                        <InputRadio class="form-check-input" 
                                    id="PhysicalJob" 
                                    Value="PhysicalActivityLevel.PhysicalJob" />
                        <label class="form-check-label" for="PhysicalJob">
                            I have a physical job
                        </label>
                    </div>
                    <div class="form-check">
                        <InputRadio class="form-check-input" 
                                    id="Athlete" 
                                    Value="PhysicalActivityLevel.Athlete" />
                        <label class="form-check-label" for="Athlete">
                            I am an athlete
                        </label>
                    </div>
                </InputRadioGroup>
            </div>

            @* QUESTION 6: EXERCISE FREQUENCY *@
            <div class="mb-4">
                <label class="form-label">
                    <strong>6. How often do you exercise?</strong>
                </label>
                <InputRadioGroup @bind-Value="Calc.ExerciseFrequency">
                    <div class="form-check">
                        <InputRadio class="form-check-input" 
                                    id="LessThanOnce" 
                                    Value="ExerciseFrequency.LessThanOnce" />
                        <label class="form-check-label" for="LessThanOnce">
                            Less than once a week
                        </label>
                    </div>
                    <div class="form-check">
                        <InputRadio class="form-check-input" 
                                    id="OnceToTwice" 
                                    Value="ExerciseFrequency.OnceToTwice" />
                        <label class="form-check-label" for="OnceToTwice">
                            1-2 times a week
                        </label>
                    </div>
                    <div class="form-check">
                        <InputRadio class="form-check-input" 
                                    id="TwoToThree" 
                                    Value="ExerciseFrequency.TwoToThree" />
                        <label class="form-check-label" for="TwoToThree">
                            2-3 times a week
                        </label>
                    </div>
                    <div class="form-check">
                        <InputRadio class="form-check-input" 
                                    id="ThreeToFive" 
                                    Value="ExerciseFrequency.ThreeToFive" />
                        <label class="form-check-label" for="ThreeToFive">
                            3-5 times a week
                        </label>
                    </div>
                    <div class="form-check">
                        <InputRadio class="form-check-input" 
                                    id="SixToSeven" 
                                    Value="ExerciseFrequency.SixToSeven" />
                        <label class="form-check-label" for="SixToSeven">
                            6-7 times a week
                        </label>
                    </div>
                </InputRadioGroup>
            </div>

            @* SUBMIT BUTTON *@
            <div class="text-center">
                <button class="btn btn-success btn-lg @(IsFormIncomplete ? "disabled" : "")"
                        @onclick="CalculateCalories"
                        disabled="@IsFormIncomplete"
                        aria-disabled="@(IsFormIncomplete.ToString().ToLower())">
                    Calculate Maintenance Calories
                </button>
            </div>

            @* RESULTS DISPLAY *@
            @if (showResults)
            {
                <div class="alert alert-info mt-4" role="alert">
                    <h4 class="alert-heading">Your Results:</h4>
                    <hr />
                    @* Display BMR and TDEE results formatting the numbers to 0 decimal places *@
                    <p><strong>Basal Metabolic Rate (BMR):</strong> @bmr.ToString("F0") calories/day</p>
                    <p><strong>Total Daily Energy Expenditure (TDEE):</strong> @tdee.ToString("F0") calories/day</p>
                    <hr />
                    <p class="mb-0">
                        <small>
                            Your TDEE represents the number of calories you burn per day based on your activity level. 
                            This is your maintenance calorie level - eat this amount to maintain your current weight.
                        </small>
                    </p>
                </div>
            }

        </div>
    </div>
</div>

@code {
    // Results variables
    private bool showResults = false;
    private double bmr = 0;
    private double tdee = 0;

    // Form validation - ensures all required fields are filled
    private bool IsFormIncomplete =>
        String.IsNullOrEmpty(Calc.Sex) ||
        Calc.HeightCm <= 0 ||
        Calc.WeightKg <= 0 ||
        Calc.Age <= 0;


    // mCalculates maintenance calories and displays results
    private void CalculateCalories()
    {
        // Guard to ensure we don't calculate when form is incomplete
        if (IsFormIncomplete)
        {
            return;
        }

        var user = Db.Users.FirstOrDefault(u => u.Username == Session.UserSession.Username);

        // Perform calculations
        bmr = Calc.CalculateBMR();
        tdee = Calc.CalculateTDEE();

        // Save results to user profile if logged in
        if (user != null)
        {
            user.Maintenance_Calories = (int)tdee;
            user.Body_Weight = (int)Calc.WeightKg;
            Db.SaveChanges();
        }


        // Show results
        showResults = true;

        // Force UI update
        StateHasChanged();
    }

    // Resets the form and hides results
    private void ResetForm()
    {
        Calc.Reset();
        showResults = false;
        bmr = 0;
        tdee = 0;
    }
}

