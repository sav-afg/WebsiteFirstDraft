@page "/"
@using WebsiteFirstDraft.Data.Models
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
@inject UISettingsService UI
@inject UserSessionService Session
@inject AppDbContext Db
@using Microsoft.EntityFrameworkCore

<PageTitle>HomePage</PageTitle>

<h3>@Session.UserSession.Username</h3>

<div class="container-fluid text-center">
    <div class="row" style="margin:2%;">
        <div class="col-sm-6">
            @* <p>UI personalisation</p> *@
            <button type="button" class="btn btn-primary" @onclick="NavToUIPersonalisation">
                UI personalisation
            </button>
        </div>

        <div class="col-sm-6">
            @* <p>Sign in/Create Account</p> *@
            <button type="button" class="btn btn-primary" @onclick="NavToAccountDetails">
                Sign in/Create Account
            </button>
        </div>
    </div>
</div>

@* Welcome message *@
<div class="container-fluid text-center">
    <div class="row" style="margin:2%;">

        @switch (UI.Settings.PrimaryGoal)
        {
            case "FatLoss":
                <p>@(NewQuote(FatLossQuotes))</p>
                break;
            case "MuscleGain":
                <p>@(NewQuote(HypertrophyQuotes))</p>
                break;
            case "Endurance":
                <p>@(NewQuote(EnduranceQuotes))</p>
                break;
            default:
                <p>@(NewQuote(GeneralHealthQuotes))</p>
                break;
        }
    </div>
</div>

@* images *@

    <div class="container-fluid text-center">
        <div class="row" style="margin:2%;">
            <div class="col-sm-4">

                <figure class="figure">
                    <img src="https://static.vecteezy.com/system/resources/previews/028/144/649/original/bunch-of-bananas-cartoon-illustration-banana-fruit-flat-icon-outline-vector.jpg"
                    class="rounded mx-auto d-block" alt="Food Logging" width="304" height="236" @onclick="NavToFoodLogging">
                <figcaption class="figure-caption @ContrastMode()">
                    <button type="button" class="btn btn-primary" @onclick="NavToFoodLogging">
                        Food Logging
                    </button>
                </figcaption>
                </figure>

            </div>
            <div class="col-sm-4">

                <figure class="figure">
                    <img src="https://st2.depositphotos.com/3557671/11465/v/950/depositphotos_114657618-stock-illustration-treadmill-icon-cartoon-single-sport.jpg"
                    class="rounded mx-auto d-block" alt="Excercise Logging" width="304" height="236" @onclick="NavToExerciseLogging">
                <figcaption class="figure-caption @ContrastMode()">
                    <button type="button" class="btn btn-primary" @onclick="NavToExerciseLogging">
                        Exercise Logging
                    </button>
                </figcaption>
                </figure>

            </div>
            <div class="col-sm-4">

                <figure class="figure">
                    <img src="https://tse1.mm.bing.net/th/id/OIP.GpGlhBwR00XUFDA4Xa8p4AHaEc?rs=1&pid=ImgDetMain&o=7&rm=3"
                    class="rounded mx-auto d-block" alt="Graphs" width="304" height="236" @onclick="NavToGraphs">
                <figcaption class="figure-caption @ContrastMode()">
                    <button type="button" class="btn btn-primary" @onclick="NavToGraphs">
                        Graphs
                    </button>
                </figcaption>
                </figure>

            </div>
        </div>
    </div>

    <hr class="bg-primary border-2 border-top border-primary" />

    <div class="container text-center">
        <!-- Columns are always 50% wide, on mobile and desktop -->
        <div class="row">
            <div class="col-6">

            @* Pie chart only displays if user is logged in AND has eaten today *@
            @if (ShouldShowPieChart())
            {
                @*Sets up a pie chart with a width property.*@
                <PieChart @ref="pieChart" Width="300" Height="300" />
            }
            else
            {
                <div class="alert alert-info" role="alert">
                    <p class="mb-0">No macro data available yet. Start logging your meals!</p>
                </div>
            }

            </div>

            <div class="col-6">
                @* Summary Statistics Card *@
                <div class="card text-start">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Summary Statistics</span>

                        @*Will display a message indicating high contrast mode is on, if its on*@
                        @if (UI.Settings.HighContrast)
                        {
                            <span class="badge bg-secondary">High Contrast</span>
                        }
                    </div>
                    <div class="card-body">

                        @*Validation to ensure that there is data to be displayed. If not it displays a message saying no summary data available*@
                        @if (chartData?.Labels != null && chartData.Datasets?.Count > 0 && chartData.Datasets[0] is PieChartDataset dataset && dataset.Data != null)
                        {

                            @*Displays a list of every item from the dataset alongside the number associated with it*@
                            <ul class="list-group list-group-flush">
                                @for (var i = 0; i < chartData.Labels.Count; i++)
                                {
                                    var label = chartData.Labels[i];
                                    var value = i < dataset.Data.Count ? dataset.Data[i] : null;
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>@label</span>

                                        @*The icon will display the grams of macros the user has consumed*@
                                        <span class="badge bg-primary rounded-pill">@((value ?? 0).ToString())g</span>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            @*Default*@
                            <p class="text-muted mb-0">No summary data available.</p>
                        }
                    </div>

                    @*Button that navigates to the graphs page*@
                    <div class="card-footer text-end">
                        <button type="button" class="btn btn-primary" @onclick="NavToGraphs">
                            View Details
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
        <hr />
    
    @* Questionnaire buttons section with bottom padding to prevent footer overlap *@
    <div class="mb-5 pb-5">
        <div class="row text-center">
            <div>
                <p>Not sure where to start? Try out our questionnaires:</p>
                <div class="d-sm-flex justify-content-between gap-2 flex-wrap">
                    <button type="button" class="btn btn-primary mb-2" @onclick="NavToDietQuestionnaire">Diet Advice</button>
                    <button type="button" class="btn btn-primary mb-2" @onclick="NavToExerciseQuestionnaire">Exercise advice</button>
                    <button type="button" class="btn btn-primary mb-2" @onclick="NavToWorkoutSplitGenerator">Workout Split Generator</button>
                    <button type="button" class="btn btn-primary mb-2" @onclick="NavToMainCalculator">Maintenance Calories Calculator</button>
                </div>
            </div>
        </div>
    </div>

@code {
    #region Navigation
    private void NavToAccountDetails()
    {
        NavigationManager.NavigateTo("accountdetails");
    }

    private void NavToFoodLogging()
    {
        NavigationManager.NavigateTo("foodlogging");
    }

    private void NavToExerciseLogging()
    {
        NavigationManager.NavigateTo("exerciselogging");
    }

    private void NavToUIPersonalisation()
    {
        NavigationManager.NavigateTo("uipersonalisation");
    }

    private void NavToGraphs()
    {
        NavigationManager.NavigateTo("graphs");
    }

    private void NavToExerciseQuestionnaire()
    {
        NavigationManager.NavigateTo("exercisequestionnaire");
    }

    private void NavToDietQuestionnaire()
    {
        NavigationManager.NavigateTo("dietquestionnaire");
    }

    private void NavToWorkoutSplitGenerator()
    {
        NavigationManager.NavigateTo("workoutsplitgenerator");
    }

    private void NavToMainCalculator()
    {
        NavigationManager.NavigateTo("maintenancecaloriesquestionnaire");
    }

    #endregion


    @*Reference to the rendered PieChart component, allowing inbuilt methods to be called
    This class originated from the NuGet package i installed (Blazor Bootstrap)*@
    private PieChart? pieChart;

    @*Adds configuration options for the chart such as title, legend position, responsiveness*@
    private PieChartOptions? pieChartOptions;

    @*Another component that holds labels and datasets*@
    private ChartData? chartData;

    @*Stores an array of predefined colours to use for the pie slices*@
    private string[]? backgroundColors;

    @*Tracks how many labels exist which is important for data and colour alignment*@
    private int dataLabelsCount = 0;

    private bool ShouldShowPieChart()
    {
        // Check if user is logged in (username is not empty)
        bool isLoggedIn = !string.IsNullOrWhiteSpace(Session.UserSession.Username);

        // Check if user has any macro data for today
        var user = Db.Users
            .FirstOrDefault(u => EF.Functions.Like(u.Username, Session.UserSession.Username));

        // Returns false if the user isn't found
        if (user == null)
            return false;

        // Sync session data with database
        Session.UserSession.Daily_Carbs = user.Daily_Carbs;
        Session.UserSession.Daily_Protein = user.Daily_Protein;
        Session.UserSession.Daily_Fat = user.Daily_Fat;

        bool hasData = user.Daily_Carbs != 0
                        || user.Daily_Protein != 0
                        || user.Daily_Fat != 0;

        return isLoggedIn && hasData;
    }

    @*This runs once when the component is created*@
    protected override void OnInitialized()
    {
        @*Loads default colours and creates the chart data with actual user data*@
        backgroundColors = ColorUtility.CategoricalTwelveColors;
        chartData = new ChartData { Labels = GetMacroLabels(), Datasets = GetUserMacroDataSets() };

        @*Configures chart options to have a responsive layout, title text and visibility, legend positioned on the bottom*@
        pieChartOptions = new();
        pieChartOptions.Responsive = true;
        pieChartOptions.Plugins.Title!.Text = "Daily Macro Breakdown";
        pieChartOptions.Plugins.Title.Display = true;
        pieChartOptions.Plugins.Legend.Position = "bottom";
    }

    @*Blazor components render before child elements are fully available. firstRender == true ensures the chart is initialised only once*@
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Only initialize chart if it's rendered AND all required objects are not null
        if (firstRender && ShouldShowPieChart() && pieChart != null && chartData != null && pieChartOptions != null)
        {
            await pieChart.InitializeAsync(chartData, pieChartOptions);
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    @*This region is used to prepare the data from the database*@
    #region Data Preparation


    // Creates a list of datasets with actual user macro data from the database
    private List<IChartDataset> GetUserMacroDataSets()
    {
        var datasets = new List<IChartDataset>
        {
            GetUserMacroPieChartDataset()
        };

        return datasets;
    }



    // Creates a dataset with the logged-in user's actual macro data
    private PieChartDataset GetUserMacroPieChartDataset()
    {
        return new PieChartDataset
        {
            Label = "Grams",
            Data = GetUserMacroData(),
            BackgroundColor = GetMacroBackgroundColors()
        };
    }


    // Gets the actual macro data from the user's session (loaded from database)
    // Returns carbs, protein, and fat values
    private List<double?> GetUserMacroData()
    {
        var data = new List<double?>
        {
            (double?)Session.UserSession.Daily_Carbs,
            (double?)Session.UserSession.Daily_Protein,
            (double?)Session.UserSession.Daily_Fat
        };

        return data;
    }


    // Assigns predefined colors to each macro slice (Carbs, Protein, Fat)
    private List<string> GetMacroBackgroundColors()
    {
        var colors = new List<string>();
        for (var index = 0; index < 3; index++) // 3 macros: carbs, protein, fat
        {
            colors.Add(backgroundColors![index]);
        }

        return colors;
    }


    // Generates the three macro labels: Carbs, Protein, Fats
    private List<string> GetMacroLabels()
    {
        dataLabelsCount = 3; // Reset to 3 for the three macros
        return new List<string> { "Carbs", "Protein", "Fats" };
    }

    #endregion  Data Preparation


    #region Arrays of quotes
    private string[] GeneralHealthQuotes = new string[5]
    {
        "You can, you should, and if you're brave enough to start, you will.",
        "The only person who can stop you from reaching your goals is you.",
        "Motivation is what gets you started. Habit is what keeps you going.",
        "If you're tired of starting over—quit giving up.",
        "It isn't the mountains ahead to climb that wears you out; it's the pebble in your shoe."
    };

    private string[] HypertrophyQuotes = new string[5]
    {
        "Success isn't always about 'greatness', it's about consistency. Consistent, hard work gains success. Greatness will come.",
        "All progress takes place outside the comfort zone.",
        "Going to the gym is great for your body, but it's also great for your mind.",
        "Know that you can start late, look different, be uncertain, and still succeed.",
        "Lightweight, Baby!"
    };

    private string[] EnduranceQuotes = new string[5]
    {
        "Sometimes, carrying on, just carrying on, is the superhuman achievement.",
        "Overpower. Overtake. Overcome.",
        "Erase the word 'failure' from your vocabulary. No case is ever truly closed, and no challenge is ever over.",
        "If you run, you are a runner. It doesn't matter how fast or how far. It doesn't matter if today is your first day or if you've been running for 20 years. There is no test to pass, no license to earn, no membership card to get. You just run.",
        "When I feel tired, I just think about how great I will feel once I finally reach my goal."
    };

    private string[] FatLossQuotes = new string[5]
    {
        "The hardest thing about exercise is to start doing it. Once you are doing exercise regularly, the hardest thing is to stop it.",
        "Take care of your body. It's the one place you have to live.",
        "An early morning walk is a blessing for the whole day.",
        "It's going to be a journey. It's not a sprint to get in shape.",
        "It's not so much that I began to run, but that I continued."
    };
    #endregion

    private Random random = new Random();

    private string NewQuote(string[] quotes)
    {
        return quotes[random.Next(0, 5)];
    }

    private string? ContrastMode()
    {
        if (UI.Settings.HighContrast)
        {
            return "high-contrast";
        }
        else
        {
            return null;
        }
    }

}