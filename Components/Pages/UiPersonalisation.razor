@page "/UiPersonalisation"
@using WebsiteFirstDraft.Data.Models
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject UISettingsService UIService
@inject UserSessionService Session
@inject AppDbContext Db

@*Title*@
<h3 class="text-center">Personalise Your Experience</h3>

@*Explanation of function of the page*@
<p class="text-center">
    Answer the questions below to customise how the website looks and behaves.
    These settings can be changed at any time.
</p>

<hr />

 @*EXPERIENCE LEVEL QUESTION*@
<label><strong>1. How experienced are you with fitness?</strong></label>
<select @bind="UIService.Settings.ExperienceLevel" class="form-select">
    <option value="Beginner">Beginner</option>
    <option value="Intermediate">Intermediate</option>
    <option value="Advanced">Advanced</option>
</select>

<br />

@*  PRIMARY GOAL QUESTION *@
<label><strong>2. What is your primary fitness goal?</strong></label>
<select @bind="UIService.Settings.PrimaryGoal" class="form-select">
    <option value="FatLoss">Fat Loss</option>
    <option value="MuscleGain">Muscle Gain</option>
    <option value="Endurance">Endurance</option>
    <option value="General">General Health</option>
</select>

<br />

<hr />
@* ACCESSIBILITY OPTIONS *@
<label><strong>3. Accessibility Preferences</strong></label>
<br />
<div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
    <input @bind="UIService.Settings.HighContrast" type="checkbox" class="btn-check" id="3btncheck1" autocomplete="off">
    <label class="btn btn-outline-primary" for="3btncheck1">Enable High Contrast Mode</label>

    <input @bind="UIService.Settings.DyslexicFont" type="checkbox" class="btn-check" id="3btncheck2" autocomplete="off">
    <label class="btn btn-outline-primary" for="3btncheck2">Enable Dyslexia-Friendly Font</label>

    <input @bind="UIService.Settings.ReduceAnimations" type="checkbox" class="btn-check" id="3btncheck3" autocomplete="off">
    <label class="btn btn-outline-primary" for="3btncheck3">Reduce Animations</label>

    <input @bind="UIService.Settings.LargerTextSize" type="checkbox" class="btn-check" id="3btncheck4" autocomplete="off">
    <label class="btn btn-outline-primary" for="3btncheck4">Larger text size</label>
</div>
<br />
<br />

 @* TRACKING*@
<label><strong>4. What do you want to track?</strong></label>
<br />
<div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
    <input @bind="UIService.Settings.Calories" type="checkbox" class="btn-check" id="4btncheck1" autocomplete="off">
    <label class="btn btn-outline-primary" for="4btncheck1">Calories only</label>

    <input @bind="UIService.Settings.Macros" type="checkbox" class="btn-check" id="4btncheck2" autocomplete="off">
    <label class="btn btn-outline-primary" for="4btncheck2">Macros (protein/carbohydrate/fat)</label>

    <input @bind="UIService.Settings.Exercise" type="checkbox" class="btn-check" id="4btncheck3" autocomplete="off">
    <label class="btn btn-outline-primary" for="4btncheck3">Exercise only</label>

    <input @bind="UIService.Settings.WeightTrends" type="checkbox" class="btn-check" id="4btncheck4" autocomplete="off">
    <label class="btn btn-outline-primary" for="4btncheck4">Weight trends</label>

    <input @bind="UIService.Settings.ShowAdvancedMetrics" type="checkbox" class="btn-check" id="4btncheck5" autocomplete="off">
    <label class="btn btn-outline-primary" for="4btncheck5">Show advanced metrics (RPE / RIR / Macros)</label>
</div>

<br />
<br />

@* Motivation *@
<label><strong>5. What motivates you the most?</strong></label>
<br />
<div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
    <input @bind="UIService.Settings.EnableGamification" type="checkbox" class="btn-check" id="5btncheck1" autocomplete="off">
    <label class="btn btn-outline-primary" for="5btncheck1">Visual rewards</label>

    <input @bind="UIService.Settings.ProgressData" type="checkbox" class="btn-check" id="5btncheck2" autocomplete="off">
    <label class="btn btn-outline-primary" for="5btncheck2">Progress data</label>

    <input @bind="UIService.Settings.MinimalInterface" type="checkbox" class="btn-check" id="5btncheck3" autocomplete="off">
    <label class="btn btn-outline-primary" for="5btncheck3">Minimal interface</label>
</div>


<hr />

<button class="btn btn-primary" @onclick="ApplySettings">
    Apply Settings
</button>

<br />
<br />

<p class="text-success">@confirmationMessage</p>
@code {

    // Message shown to the user once settings are applied
    private string confirmationMessage = "";

    // Called when user clicks "Apply Settings"
    private async Task ApplySettings()
    {
        try
        {
            // Update UserSession with UI settings
            UpdateUserSession();

            // Save to database
            await SaveToDatabase();

            // Show confirmation immediately
            confirmationMessage = "Your preferences have been saved and applied.";
            StateHasChanged();

            // Keep the message visible for 1 second
            await Task.Delay(1000);

            // Hide the confirmation message
            confirmationMessage = string.Empty;

            // Reload the current page to apply settings
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
        catch (Exception ex)
        {
            confirmationMessage = $"Error saving settings: {ex.Message}";
            StateHasChanged();
        }
    }

    // Update UserSession with values from UIService.Settings
    private void UpdateUserSession()
    {
        Session.UserSession.High_Contrast_Mode = UIService.Settings.HighContrast;
        Session.UserSession.Dyslexia_Friendly_Font = UIService.Settings.DyslexicFont;
        Session.UserSession.Reduced_Animations = UIService.Settings.ReduceAnimations;
        Session.UserSession.Larger_Font_Size = UIService.Settings.LargerTextSize;
        Session.UserSession.Visual_Rewards = UIService.Settings.EnableGamification;
        Session.UserSession.Progress_Data = UIService.Settings.ProgressData;
        Session.UserSession.Minimal_Interface = UIService.Settings.MinimalInterface;

        // Build tracking preferences string from checkboxes
        var trackingPreferences = new List<string>();
        if (UIService.Settings.Calories) trackingPreferences.Add("Calories");
        if (UIService.Settings.Macros) trackingPreferences.Add("Macros");
        if (UIService.Settings.Exercise) trackingPreferences.Add("Exercise");
        if (UIService.Settings.WeightTrends) trackingPreferences.Add("WeightTrends");
        if (UIService.Settings.ShowAdvancedMetrics) trackingPreferences.Add("AdvancedMetrics");

        Session.UserSession.Tracking_Preferences = string.Join(",", trackingPreferences);
    }

    // Save UserSession settings to the database
    private async Task SaveToDatabase()
    {
        // Validate username exists in session
        if (string.IsNullOrWhiteSpace(Session.UserSession.Username))
        {
            throw new InvalidOperationException("Session username is null or empty");
        }

        // Find the user in the database by username (case-insensitive)
        var normalizedUsername = Session.UserSession.Username.ToLower();
        var user = await Db.Users 
        // .Use case-insensitive comparison for username
            .FirstOrDefaultAsync(u => EF.Functions.Like(u.Username, Session.UserSession.Username));

        // Throw an exception if user not found
        if (user == null)
        {
            throw new InvalidOperationException($"User '{Session.UserSession.Username}' not found in database");
        }

        // Update user database record with session values
        user.High_Contrast_Mode = Session.UserSession.High_Contrast_Mode;
        user.Dyslexia_Friendly_Font = Session.UserSession.Dyslexia_Friendly_Font;
        user.Reduced_Animations = Session.UserSession.Reduced_Animations;
        user.Larger_Font_Size = Session.UserSession.Larger_Font_Size;
        user.Visual_Rewards = Session.UserSession.Visual_Rewards;
        user.Progress_Data = Session.UserSession.Progress_Data;
        user.Minimal_Interface = Session.UserSession.Minimal_Interface;
        user.Tracking_Preferences = Session.UserSession.Tracking_Preferences;

        // Save changes to database
        await Db.SaveChangesAsync();
    }

}

